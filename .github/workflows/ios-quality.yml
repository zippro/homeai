name: iOS Quality

on:
  push:
    paths:
      - "mobile-ios/**"
      - ".github/workflows/ios-quality.yml"
  pull_request:
    paths:
      - "mobile-ios/**"
      - ".github/workflows/ios-quality.yml"

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: |
          cd mobile-ios
          xcodegen generate

      - name: Resolve concrete simulator destination
        id: destination
        run: |
          DESTINATION_ID=$(xcodebuild -project mobile-ios/HomeAI.xcodeproj -scheme HomeAI -showdestinations 2>/dev/null | awk '
            /platform:iOS Simulator/ && /id:/ && /name:/ && $0 !~ /Any iOS Simulator Device/ && $0 !~ /dvtdevice/ {
              n=split($0, parts, ",");
              for (i=1; i<=n; i++) {
                gsub(/^[[:space:]\{]+|[[:space:]\}]+$/, "", parts[i]);
                if (parts[i] ~ /^id:/) {
                  sub(/^id:/, "", parts[i]);
                  gsub(/^[[:space:]]+|[[:space:]]+$/, "", parts[i]);
                  print parts[i];
                  exit;
                }
              }
            }
          ')
          if [ -z "${DESTINATION_ID}" ]; then
            DESTINATION_ID=$(xcodebuild -project mobile-ios/HomeAI.xcodeproj -scheme HomeAI -showdestinations 2>/dev/null | awk '
              /platform:macOS/ && /id:/ && /name:/ {
                n=split($0, parts, ",");
                for (i=1; i<=n; i++) {
                  gsub(/^[[:space:]\{]+|[[:space:]\}]+$/, "", parts[i]);
                  if (parts[i] ~ /^id:/) {
                    sub(/^id:/, "", parts[i]);
                    gsub(/^[[:space:]]+|[[:space:]]+$/, "", parts[i]);
                    print parts[i];
                    exit;
                  }
                }
              }
            ')
          fi
          if [ -z "${DESTINATION_ID}" ]; then
            echo "No concrete iOS simulator or macOS Designed-for-iPad/iPhone destination found."
            xcodebuild -project mobile-ios/HomeAI.xcodeproj -scheme HomeAI -showdestinations
            exit 1
          fi
          echo "destination_id=${DESTINATION_ID}" >> "$GITHUB_OUTPUT"

      - name: Build for iOS simulator (build-for-testing)
        run: |
          xcodebuild -project mobile-ios/HomeAI.xcodeproj \
            -scheme HomeAI \
            -configuration Debug \
            -destination "id=${{ steps.destination.outputs.destination_id }}" \
            CODE_SIGNING_ALLOWED=NO \
            -derivedDataPath /tmp/HomeAIDerived \
            build-for-testing

      - name: Run iOS unit tests
        run: |
          xcodebuild -project mobile-ios/HomeAI.xcodeproj \
            -scheme HomeAI \
            -configuration Debug \
            -destination "id=${{ steps.destination.outputs.destination_id }}" \
            -derivedDataPath /tmp/HomeAIDerived \
            test-without-building
